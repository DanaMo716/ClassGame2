<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù„Ø¹Ø¨Ø© ÙƒÙˆÙ‘Ù† Ø§Ù„ÙƒÙ„Ù…Ø© - ØªØ¹Ù„Ù‘Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
    <style>
         :root {
            --bg: #f7f7fb;
            --card: #fff;
            --ink: #1f2937;
            --muted: #6b7280;
            --accent: #3a86ff;
            --ok: #22c55e;
            --bad: #ef4444;
            --shadow: 0 8px 20px rgba(0, 0, 0, .08);
            --radius: 14px;
            --base-font: clamp(16px, 3.6vw, 18px);
            --title: clamp(22px, 5.6vw, 32px);
            --slot: clamp(54px, 10vw, 70px);
            --tile-font: clamp(22px, 5.4vw, 28px);
            --pad: clamp(12px, 3.2vw, 18px);
        }
        
        html,
        body {
            height: 100%
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", "Cairo", "Noto Naskh Arabic", Arial, sans-serif;
            font-size: var(--base-font);
            padding: 12px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .app {
            width: min(1100px, 100%);
            margin-inline: auto
        }
        
        header {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap
        }
        
        .title {
            font-weight: 800;
            font-size: var(--title)
        }
        
        .sub {
            color: var(--muted);
            font-size: clamp(13px, 3.2vw, 15px)
        }
        
        .stats {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }
        
        .chip {
            background: #eef2ff;
            color: #1f3aed;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 800;
            border: 1px solid #dbeafe;
            font-size: clamp(12px, 3.2vw, 14px)
        }
        
        .btn {
            border: 0;
            padding: 10px 14px;
            border-radius: 12px;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-weight: 800;
            box-shadow: 0 4px 12px rgba(58, 134, 255, .28);
            user-select: none;
            touch-action: manipulation
        }
        
        .btn:active {
            transform: translateY(1px)
        }
        
        .btn.secondary {
            background: #eef2f7;
            color: #111;
            box-shadow: none;
            border: 1px solid #e5e7eb
        }
        
        .btn.good {
            background: var(--ok)
        }
        
        .btn.bad {
            background: var(--bad)
        }
        
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: var(--pad);
            box-shadow: var(--shadow);
            border: 1px solid #eee
        }
        
        .board {
            display: grid;
            gap: 14px;
            grid-template-columns: 1fr
        }
        
        .hint {
            background: #f8fafc;
            border: 1px dashed #dbeafe;
            padding: 12px;
            border-radius: 12px;
            color: #0f172a;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap
        }
        
        .lvl {
            font-weight: 800
        }
        
        .slots,
        .bank {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            min-height: calc(var(--slot) + 16px);
            padding: 12px;
            border-radius: 12px;
            background: #fafafa;
            border: 1px solid #eee;
            justify-content: center
        }
        
        .bank {
            background: #f1f5f9
        }
        
        .slot {
            width: var(--slot);
            height: calc(var(--slot)*1.15);
            border-radius: 12px;
            border: 2px dashed #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--tile-font);
            font-weight: 900;
            background: #fff;
            transition: background .2s, border-color .2s
        }
        
        .slot.filled {
            border-style: solid;
            border-color: #a5b4fc;
            background: #eef2ff
        }
        
        .tile {
            user-select: none;
            padding: 12px 14px;
            font-size: var(--tile-font);
            font-weight: 900;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: grab;
            box-shadow: var(--shadow);
            transition: transform .1s ease, border-color .2s, background .2s
        }
        
        .tile:active {
            cursor: grabbing;
            transform: scale(.98)
        }
        
        .tile.dragging {
            opacity: .85
        }
        
        .result {
            margin-top: 6px;
            font-weight: 900;
            font-size: clamp(18px, 4.8vw, 20px);
            display: none;
            padding: 12px 14px;
            border-radius: 12px
        }
        
        .result.ok {
            display: block;
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0
        }
        
        .result.bad {
            display: block;
            background: #fef2f2;
            color: #7f1d1d;
            border: 1px solid #fecaca
        }
        
        .footer {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap
        }
        
        .progress {
            --p: 0%;
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            position: relative
        }
        
        .progress::after {
            content: "";
            position: absolute;
            inset: 0;
            width: var(--p);
            background: linear-gradient(90deg, #3a86ff, #22c55e)
        }
        
        .ribbon {
            position: fixed;
            inset-inline-end: 10px;
            inset-block-start: 10px;
            background: #fff;
            padding: 8px 10px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
            font-size: 12px
        }
        
        dialog {
            border: 0;
            border-radius: 16px;
            padding: 0;
            box-shadow: var(--shadow);
            width: min(560px, 95vw)
        }
        
        .modal-head {
            padding: 12px 14px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center
        }
        
        .modal-body {
            padding: 14px
        }
        
        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #fff;
            font-family: inherit;
            font-size: inherit
        }
        
        .grid {
            display: grid;
            gap: 10px;
            grid-template-columns: 1fr 1fr
        }
        
        .grid>div {
            display: flex;
            flex-direction: column;
            gap: 6px
        }
        
        .tiny {
            font-size: 13px;
            color: var(--muted)
        }
        
        .level-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 12px
        }
        
        .level-card {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow);
            border: 2px solid #eee;
            cursor: pointer;
            transition: .2s
        }
        
        .level-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent)
        }
        
        .level-card.active {
            border-color: var(--accent);
            background: #f0f7ff
        }
        
        .level-title {
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 6px
        }
        
        .level-desc {
            font-size: 13px;
            color: var(--muted)
        }
        
        @media (max-width:700px) {
            .btn {
                font-size: clamp(14px, 3.6vw, 16px)
            }
            .card {
                padding: 12px
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div>
                <div class="title">ğŸ® Ù„Ø¹Ø¨Ø© <span style="color:var(--accent)">ÙƒÙˆÙ‘Ù† Ø§Ù„ÙƒÙ„Ù…Ø©</span></div>
                <div class="sub">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø­Ø±ÙˆÙ Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
            </div>
            <div class="stats">
                <div class="chip">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="levelNow">1</span></div>
                <div class="chip">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="scoreNow">0</span> â­</div>
                <button class="btn secondary" id="btnLevels">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</button>
                <button class="btn secondary" id="btnTeacher">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…</button>
            </div>
        </header>

        <div class="card board">
            <div class="hint">
                <div class="left"><span>ğŸ’¡ ØªÙ„Ù…ÙŠØ­:</span> <strong id="hintText">--</strong></div>
                <div class="lvl">Ø§Ù„ÙƒÙ„Ù…Ø©: <span id="wordLen">0</span> Ø­Ø±ÙˆÙ</div>
            </div>

            <div class="slots" id="slots"></div>
            <div class="bank" id="bank"></div>

            <div class="result" id="result"></div>

            <div class="footer">
                <button class="btn" id="btnCheck">ØªØ­Ù‚Ù‚ âœ…</button>
                <div class="progress" id="progress"></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn secondary" id="btnHint">ØªÙ„Ù…ÙŠØ­ Ø²Ø§Ø¦Ø¯ ğŸª„</button>
                    <button class="btn secondary" id="btnShuffle">Ø®Ù„Ø· Ø§Ù„Ø­Ø±ÙˆÙ ğŸ”€</button>
                    <button class="btn secondary" id="btnResetLevel">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ â†º</button>
                    <button class="btn bad" id="btnReset">Ø¥Ø¹Ø§Ø¯Ø© â†º</button>
                    <button class="btn good" id="btnNext" disabled>Ø§Ù„ØªØ§Ù„ÙŠ â–¶</button>
                </div>
            </div>
        </div>
    </div>

    <div class="ribbon">ğŸ§  ØªÙ‚Ø¯Ù‘Ù…Ùƒ Ù…Ø­ÙÙˆØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>

    <!-- Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª -->
    <dialog id="levelsDlg">
        <div class="modal-head">
            <strong>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</strong>
            <button class="btn secondary" onclick="levelsDlg.close()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="modal-body">
            <div class="level-selector" id="levelSelector">
                <div class="level-card" data-level="1">
                    <div class="level-title">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„</div>
                    <div class="level-desc">Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…Ù†ÙØ±Ø¯Ø©</div>
                </div>
                <div class="level-card" data-level="2">
                    <div class="level-title">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
                    <div class="level-desc">ÙƒÙ„Ù…Ø§Øª Ù‚ØµÙŠØ±Ø© (3 Ø£Ø­Ø±Ù)</div>
                </div>
                <div class="level-card" data-level="3">
                    <div class="level-title">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù„Ø«</div>
                    <div class="level-desc">ÙƒÙ„Ù…Ø§Øª Ø£Ø·ÙˆÙ„ (4â€“5)</div>
                </div>
            </div>
            <div class="action-bar">
                <div class="action-buttons">
                    <button class="btn secondary" id="btnClearLevelProgress">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                    <button class="btn secondary" id="btnClearAllProgress">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… -->
    <dialog id="teacherDlg">
        <div class="modal-head">
            <strong>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… (Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©)</strong>
            <button class="btn secondary" onclick="teacherDlg.close()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="modal-body">
            <div class="tiny">Ø£Ø¶ÙŠÙÙŠ ÙƒÙ„Ù…Ø§Øª Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰. ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</div>
            <div class="grid">
                <div><label>Ø§Ù„ÙƒÙ„Ù…Ø©:</label><input id="tWord" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯Ø±Ø³Ø©"></div>
                <div><label>ØªÙ„Ù…ÙŠØ­:</label><input id="tHint" placeholder="ğŸ« Ù…ÙƒØ§Ù† Ù„Ù„ØªØ¹Ù„Ù…"></div>
            </div>
            <div class="grid" style="margin-top:10px;">
                <div><label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
                    <select id="tLevel"><option value="1">1 (Ø§Ù„Ø­Ø±ÙˆÙ)</option><option value="2">2 (ÙƒÙ„Ù…Ø§Øª Ù‚ØµÙŠØ±Ø©)</option><option value="3">3 (ÙƒÙ„Ù…Ø§Øª Ø£Ø·ÙˆÙ„)</option></select>
                </div>
                <div><label>Ø­Ø±ÙˆÙ Ù…ÙØ´ÙˆÙÙ‘Ø´Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label><input id="tNoise" placeholder="Ù…Ø«Ø§Ù„: Ø«ØŒØ°ØŒØ¤"></div>
            </div>
            <div class="action-bar" style="margin-top:12px;">
                <div class="action-buttons">
                    <button class="btn" id="btnAddWord">Ø¥Ø¶Ø§ÙØ© â•</button>
                    <button class="btn bad" id="btnClearAll">Ø­Ø°Ù Ø§Ù„Ù…Ø¶Ø§Ù ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        (() => {

            /* ===== Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ© ===== */
            const builtInBank = {
                1: [{
                    w: "Ø¨",
                    hint: "ğŸ“˜ Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù† (Ø¨Ø§Ø¨)",
                    noise: "ØªØŒØ«"
                }, {
                    w: "Øª",
                    hint: "ğŸ Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù† (ØªÙØ§Ø­)",
                    noise: "Ø«ØŒØ¨"
                }, {
                    w: "Ø§",
                    hint: "ğŸ¦ Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù† (Ø£Ø³Ø¯)",
                    noise: "ÙˆØŒÙŠ"
                }, {
                    w: "Ø¹",
                    hint: "ğŸš© Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù† (Ø¹Ù„Ù…)",
                    noise: "ØºØŒØ­"
                }, {
                    w: "Ø³",
                    hint: "ğŸŸ Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù† (Ø³Ù…Ùƒ)",
                    noise: "Ø´ØŒØµ"
                }, {
                    w: "Ø¯",
                    hint: "ğŸ» Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù† (Ø¯Ø¨)",
                    noise: "Ø°ØŒØ±"
                }],
                2: [{
                    w: "Ø¨Ø§Ø¨",
                    hint: "ğŸšª Ù†Ø¯Ø®Ù„ Ù…Ù†Ù‡"
                }, {
                    w: "Ù‚Ù„Ù…",
                    hint: "âœï¸ Ù†ÙƒØªØ¨ Ø¨Ù‡"
                }, {
                    w: "Ù†Ù…Ù„",
                    hint: "ğŸœ Ø­Ø´Ø±Ø§Øª ØµØºÙŠØ±Ø©"
                }, {
                    w: "Ø¨ÙŠØª",
                    hint: "ğŸ  Ù†Ø³ÙƒÙ† ÙÙŠÙ‡"
                }, {
                    w: "ÙÙŠÙ„",
                    hint: "ğŸ˜ Ù„Ù‡ Ø®Ø±Ø·ÙˆÙ…"
                }],
                3: [{
                    w: "ÙƒØªØ§Ø¨",
                    hint: "ğŸ“˜ Ù†Ù‚Ø±Ø£ ÙÙŠÙ‡"
                }, {
                    w: "Ù†Ø§ÙØ°Ø©",
                    hint: "ğŸªŸ ÙŠØ¯Ø®Ù„ Ù…Ù†Ù‡Ø§ Ø§Ù„Ø¶ÙˆØ¡"
                }, {
                    w: "Ø´Ø¬Ø±Ø©",
                    hint: "ğŸŒ³ ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©"
                }, {
                    w: "Ø·Ø¨ÙŠØ¨",
                    hint: "ğŸ‘¨â€âš•ï¸ ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø±Ø¶Ù‰"
                }, {
                    w: "ÙƒØ±Ø³ÙŠ",
                    hint: "ğŸª‘ Ù†Ø¬Ù„Ø³ Ø¹Ù„ÙŠÙ‡"
                }]
            };

            /* ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ */
            const teacherKey = "wb_teacher_words_v2";

            function loadTeacherWords() {
                try {
                    return JSON.parse(localStorage.getItem(teacherKey) || "{}")
                } catch {
                    return {}
                }
            }

            function saveTeacherWords(d) {
                localStorage.setItem(teacherKey, JSON.stringify(d || {}));
            }

            function getFullBank() {
                const t = loadTeacherWords();
                const m = {
                    1: [...builtInBank[1]],
                    2: [...builtInBank[2]],
                    3: [...builtInBank[3]]
                };
                for (const lvl of[1, 2, 3])
                    if (t[lvl]) m[lvl].push(...t[lvl]);
                return m;
            }

            const stateKey = "wb_state_v2";

            function loadState() {
                try {
                    return JSON.parse(localStorage.getItem(stateKey)) || {
                        level: 1,
                        score: 0,
                        done: {}
                    }
                } catch {
                    return {
                        level: 1,
                        score: 0,
                        done: {}
                    }
                }
            }
            const state = loadState();
            const saveState = () => localStorage.setItem(stateKey, JSON.stringify(state));

            /* Ø¹Ù†Ø§ØµØ± */
            const el = {
                levelNow: document.getElementById("levelNow"),
                scoreNow: document.getElementById("scoreNow"),
                hintText: document.getElementById("hintText"),
                wordLen: document.getElementById("wordLen"),
                slots: document.getElementById("slots"),
                bank: document.getElementById("bank"),
                result: document.getElementById("result"),
                btnCheck: document.getElementById("btnCheck"),
                btnReset: document.getElementById("btnReset"),
                btnResetLevel: document.getElementById("btnResetLevel"),
                btnShuffle: document.getElementById("btnShuffle"),
                btnHint: document.getElementById("btnHint"),
                btnNext: document.getElementById("btnNext"),
                progress: document.getElementById("progress"),
                btnTeacher: document.getElementById("btnTeacher"),
                btnLevels: document.getElementById("btnLevels"),
                teacherDlg: document.getElementById("teacherDlg"),
                levelsDlg: document.getElementById("levelsDlg"),
                levelSelector: document.getElementById("levelSelector"),
                btnClearLevelProgress: document.getElementById("btnClearLevelProgress"),
                btnClearAllProgress: document.getElementById("btnClearAllProgress"),
                tWord: document.getElementById("tWord"),
                tHint: document.getElementById("tHint"),
                tLevel: document.getElementById("tLevel"),
                tNoise: document.getElementById("tNoise"),
                btnAddWord: document.getElementById("btnAddWord"),
                btnClearAll: document.getElementById("btnClearAll"),
            };

            /* ØµÙˆØªÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© */
            const ctx = new(window.AudioContext || window.webkitAudioContext)();

            function ensureAudio() {
                if (ctx && ctx.state !== 'running') {
                    ctx.resume().catch(() => {});
                }
            }
            ['pointerdown', 'touchstart', 'keydown', 'click'].forEach(e => window.addEventListener(e, () => ensureAudio(), {
                once: true,
                passive: true
            }));

            function beep(freq = 880, ms = 120, type = "sine", vol = .03) {
                const o = ctx.createOscillator(),
                    g = ctx.createGain();
                o.type = type;
                o.frequency.value = freq;
                g.gain.value = vol;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => o.stop(), ms);
            }

            function successSound() {
                const notes = [523.25, 659.25, 783.99];
                notes.forEach((f, i) => {
                    const o = ctx.createOscillator(),
                        g = ctx.createGain();
                    o.type = 'sine';
                    o.frequency.value = f;
                    g.gain.value = .08;
                    o.connect(g);
                    g.connect(ctx.destination);
                    o.start(ctx.currentTime + i * .1);
                    o.stop(ctx.currentTime + i * .1 + .22);
                    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * .1 + .25);
                });
            }

            const rand = a => a[Math.floor(Math.random() * a.length)];
            const shuffle = a => a.map(v => [Math.random(), v]).sort((x, y) => x[0] - y[0]).map(p => p[1]);

            let current = null; // {word, fullWord, hint, letters, noise}

            function pickWord() {
                const bank = getFullBank()[state.level] || [];
                if (!state.done[state.level]) state.done[state.level] = [];
                const cand = bank.filter(x => !state.done[state.level].includes(x.w));
                if (!cand.length) {
                    state.done[state.level] = [];
                    saveState();
                    return pickWord();
                }
                const ch = rand(cand);
                const word = ch.w.replace(/\s+/g, '');
                const letters = [...word];
                let noise = [];
                if (ch.noise) {
                    noise = ch.noise.split(/[,ØŒ\/]/).map(s => s.trim()).filter(Boolean);
                } else {
                    const pool = "Ø§Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠØ©Ø¡";
                    while (noise.length < Math.min(3, Math.max(0, 6 - letters.length))) {
                        const n = pool[Math.floor(Math.random() * pool.length)];
                        if (!letters.includes(n)) noise.push(n);
                    }
                }
                current = {
                    word,
                    fullWord: ch.w,
                    hint: ch.hint || "--",
                    letters,
                    noise
                };
                renderRound();
            }

            function renderRound() {
                el.result.className = "result";
                el.result.style.display = "none";
                el.btnNext.disabled = true;
                el.levelNow.textContent = state.level;
                el.scoreNow.textContent = state.score;
                el.hintText.textContent = current.hint;
                el.wordLen.textContent = current.letters.length;
                el.progress.style.setProperty("--p", progressPercent() + "%");
                el.slots.innerHTML = "";
                current.letters.forEach((_, i) => {
                    const s = document.createElement('div');
                    s.className = 'slot';
                    s.dataset.index = i;
                    s.addEventListener('dragover', ev => ev.preventDefault());
                    s.addEventListener('drop', onDropToSlot);
                    el.slots.appendChild(s);
                });
                el.bank.innerHTML = "";
                shuffle([...current.letters, ...current.noise]).forEach(ch => el.bank.appendChild(makeTile(ch)));
            }

            function makeTile(ch) {
                const t = document.createElement('div');
                t.className = 'tile';
                t.draggable = true;
                t.textContent = ch;
                t.dataset.letter = ch;
                t.addEventListener('dragstart', ev => {
                    t.classList.add('dragging');
                    ev.dataTransfer.setData('text/plain', ch);
                    window.__draggingTile = t;
                });
                t.addEventListener('dragend', () => t.classList.remove('dragging'));
                t.addEventListener('dblclick', () => {
                    if (t.parentElement && t.parentElement.classList.contains('slot')) t.parentElement.classList.remove('filled');
                    el.bank.appendChild(t);
                });
                t.addEventListener('click', () => {
                    const empty = [...el.slots.children].find(s => !s.firstElementChild);
                    if (empty) {
                        if (t.parentElement && t.parentElement.classList.contains('slot')) t.parentElement.classList.remove('filled');
                        empty.appendChild(t);
                        empty.classList.add('filled');
                        beep(900, 60, "triangle", .02);
                    }
                });
                return t;
            }

            function onDropToSlot(ev) {
                ev.preventDefault();
                const slot = ev.currentTarget;
                const tile = window.__draggingTile;
                if (!tile) return;
                if (slot.firstElementChild) el.bank.appendChild(slot.firstElementChild);
                slot.innerHTML = "";
                slot.appendChild(tile);
                slot.classList.add('filled');
                beep(900, 60, "triangle", .02);
            }

            function collectAnswer() {
                return [...el.slots.children].map(s => s.firstElementChild ? s.firstElementChild.dataset.letter : "").join("");
            }

            function showResult(ok, msg) {
                el.result.className = "result " + (ok ? "ok" : "bad");
                el.result.textContent = msg;
                el.result.style.display = "block";
            }

            function progressPercent() {
                if (!state.done[state.level]) return 0;
                const bank = getFullBank()[state.level] || [];
                const total = bank.length || 1;
                const done = state.done[state.level].length;
                return Math.round(100 * done / total);
            }

            function check() {
                const ans = collectAnswer();
                if (ans.length !== current.letters.length) {
                    beep(200, 150, "sawtooth", .03);
                    return showResult(false, "ÙƒÙ…Ù‘Ù„ÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙˆÙ Ø£ÙˆÙ„Ø§Ù‹ ğŸ‘€");
                }
                if (ans === current.word) {
                    showResult(true, "ğŸ‰ Ø£Ø­Ø³Ù†ØªÙ! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©");
                    el.btnNext.disabled = false;
                    state.score += 5;
                    if (!state.done[state.level]) state.done[state.level] = [];
                    if (!state.done[state.level].includes(current.fullWord)) state.done[state.level].push(current.fullWord);
                    saveState();
                    successSound();
                    confetti();
                } else {
                    showResult(false, "âŒ Ù„ÙŠØ³Øª ØµØ­ÙŠØ­Ø©. Ø¬Ø±Ù‘Ø¨ÙŠ Ø®Ù„Ø· Ø§Ù„Ø­Ø±ÙˆÙ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù…ÙŠ ØªÙ„Ù…ÙŠØ­Ù‹Ø§ Ø¥Ø¶Ø§ÙÙŠÙ‹Ø§.");
                    state.score = Math.max(0, state.score - 1);
                    saveState();
                    shake(el.slots);
                    beep(160, 220, "sine", .03);
                }
                el.scoreNow.textContent = state.score;
                el.progress.style.setProperty("--p", progressPercent() + "%");
            }

            function resetRound() {
                [...el.slots.children].forEach(s => {
                    if (s.firstElementChild) el.bank.appendChild(s.firstElementChild);
                    s.classList.remove('filled');
                });
                el.result.style.display = "none";
            }

            function resetLevel() {
                if (confirm("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ")) {
                    if (state.done[state.level]) {
                        state.done[state.level] = [];
                        saveState();
                        resetRound();
                        pickWord();
                    }
                }
            }

            function extraHint() {
                const emptyIdx = [...el.slots.children].map((s, i) => s.firstElementChild ? null : i).filter(i => i !== null);
                if (!emptyIdx.length) return;
                const i = rand(emptyIdx),
                    ch = current.letters[i];
                // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ù„Ø§Ø·Ø©
                const inBank = [...el.bank.children].find(t => t.dataset.letter === ch);
                const inWrong = [...el.slots.children].find(s => s.firstElementChild && s.firstElementChild.dataset.letter === ch && parseInt(s.dataset.index) !== i);
                let tile = inBank || (inWrong ? inWrong.firstElementChild : null);
                if (!tile) return;
                const target = el.slots.children[i];
                if (target.firstElementChild) el.bank.appendChild(target.firstElementChild);
                target.appendChild(tile);
                target.classList.add('filled');
                beep(980, 80, "triangle", .02);
            }

            function shuffleBank() {
                const arr = [...el.bank.children];
                arr.sort(() => Math.random() - .5).forEach(n => el.bank.appendChild(n));
                beep(400, 70, "square", .02);
            }

            function shake(elm) {
                elm.animate([{
                    transform: 'translateX(0)'
                }, {
                    transform: 'translateX(-6px)'
                }, {
                    transform: 'translateX(6px)'
                }, {
                    transform: 'translateX(0)'
                }], {
                    duration: 260
                });
            }

            function confetti() {
                const n = 18;
                for (let i = 0; i < n; i++) {
                    const p = document.createElement('div');
                    p.style.cssText = `position:fixed;width:10px;height:10px;background:hsl(${Math.random()*360},90%,60%);inset-inline-start:${(Math.random()*80+10)}vw;inset-block-start:0;border-radius:2px;z-index:9999`;
                    document.body.appendChild(p);
                    p.animate([{
                        transform: 'translateY(0) rotate(0deg)'
                    }, {
                        transform: 'translateY(80vh) rotate(' + (Math.random() * 720 - 360) + 'deg)'
                    }], {
                        duration: 1100 + Math.random() * 600,
                        easing: "cubic-bezier(.2,.7,.2,1)"
                    }).onfinish = () => p.remove();
                }
            }

            /* ÙˆØ§Ø¬Ù‡Ø© */
            function setupLevelSelector() {
                const cards = el.levelSelector.querySelectorAll('.level-card');
                cards.forEach(card => {
                    const level = parseInt(card.dataset.level);
                    card.addEventListener('click', () => {
                        cards.forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        state.level = level;
                        saveState();
                        el.levelsDlg.close();
                        pickWord();
                    });
                    if (level === state.level) card.classList.add('active');
                });
            }

            /* Ø¨Ø¯Ø¡ */
            setupLevelSelector();
            pickWord();

            /* Ø£Ø²Ø±Ø§Ø± */
            el.btnCheck.addEventListener('click', check);
            el.btnReset.addEventListener('click', () => {
                if (confirm("Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ")) {
                    state.level = 1;
                    state.score = 0;
                    state.done = {};
                    saveState();
                    pickWord();
                }
            });
            el.btnResetLevel.addEventListener('click', resetLevel);
            el.btnShuffle.addEventListener('click', shuffleBank);
            el.btnHint.addEventListener('click', extraHint);
            el.btnNext.addEventListener('click', () => {
                state.done[state.level] = state.done[state.level] || [];
                state.done[state.level].push(current.fullWord);
                saveState();
                pickWord();
            });
            el.btnTeacher.addEventListener('click', () => el.teacherDlg.showModal());
            el.btnLevels.addEventListener('click', () => el.levelsDlg.showModal());
            el.btnClearLevelProgress.addEventListener('click', () => {
                if (confirm(`Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${state.level}ØŸ`)) {
                    state.done[state.level] = [];
                    saveState();
                    pickWord();
                }
            });
            el.btnClearAllProgress.addEventListener('click', () => {
                if (confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…ØŸ")) {
                    state.done = {};
                    state.score = 0;
                    saveState();
                    pickWord();
                }
            });
            el.btnAddWord.addEventListener('click', () => {
                const w = (el.tWord.value || "").trim();
                const h = (el.tHint.value || "").trim() || "--";
                const lvl = parseInt(el.tLevel.value || "1");
                if (!w) {
                    alert("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø£ÙˆÙ„Ù‹Ø§");
                    return;
                }
                const noise = (el.tNoise.value || "").trim();
                const data = loadTeacherWords();
                if (!data[lvl]) data[lvl] = [];
                data[lvl].push({
                    w,
                    hint: h,
                    noise
                });
                saveTeacherWords(data);
                el.tWord.value = "";
                el.tHint.value = "";
                el.tNoise.value = "";
                alert("Ø£ÙØ¶ÙŠÙØª âœ…");
            });
            el.btnClearAll.addEventListener('click', () => {
                if (confirm("Ø­Ø°Ù ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ØŸ")) {
                    saveTeacherWords({});
                    alert("ØªÙ… Ø§Ù„Ø­Ø°Ù.");
                }
            });

        })();
    </script>
</body>

</html>