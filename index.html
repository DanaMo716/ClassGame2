<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>لعبة صياد الكلمات - تعلّم العربية</title>
    <style>
         :root {
            --bg: #f9f7f5;
            --card: #ffffff;
            --ink: #222;
            --muted: #666;
            --accent: #ff7043;
            --ok: #4caf50;
            --bad: #f44336;
            --shadow: 0 8px 20px rgba(0, 0, 0, .08);
            --cell: 38px;
            /* 👈 كبّر/صغّر حجم الخلية من هنا */
            --gap: 8px;
        }
        
        html,
        body {
            height: 100%;
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Amiri", "Cairo", Arial, sans-serif;
        }
        
        .app {
            width: min(1100px, 100%);
            margin: 16px auto;
            /* يوسّط المحتوى أفقياً ويبدأ من أعلى الصفحة */
        }
        
        header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            /* يخلي الهيدر ثابت فوق */
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--bg);
            padding-block: 8px;
        }
        
        .title {
            font-weight: 800;
            font-size: clamp(22px, 2.8vw, 32px);
        }
        
        .sub {
            color: var(--muted);
            font-size: 15px;
        }
        
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        
        .stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chip {
            background: #fff4ef;
            color: #ff5722;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn {
            border: 0;
            padding: 12px 16px;
            border-radius: 10px;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(255, 112, 67, .3);
            transition: transform .05s ease;
        }
        
        .btn:active {
            transform: translateY(1px)
        }
        
        .btn.secondary {
            background: #e5e7eb;
            color: #111;
            box-shadow: none;
        }
        
        .btn.good {
            background: var(--ok);
            box-shadow: 0 4px 12px rgba(76, 175, 80, .25);
        }
        
        .btn.bad {
            background: var(--bad);
        }
        /* الشبكة: عدد الأعمدة = gridSize، وحجم الخلية من --cell */
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(var(--cols, 8), var(--cell));
            gap: var(--gap);
            margin-top: 20px;
            width: fit-content;
            margin-inline: auto;
            /* توسيط الشبكة */
        }
        
        .grid-cell {
            width: var(--cell);
            aspect-ratio: 1;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--cell) * .5);
            font-weight: 700;
            cursor: pointer;
            transition: all .2s ease;
            user-select: none;
        }
        
        .grid-cell:hover {
            background: #fef9f6;
            border-color: #ffdccf;
        }
        
        .grid-cell.selected {
            background: #ffe9e0;
            border-color: var(--accent);
            color: #ff5722;
        }
        
        .grid-cell.correct {
            /* ألوانها تُضبط inline حسب كل كلمة */
        }
        
        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .word-item {
            background: #f5f5f5;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 16px;
            transition: .2s;
            border: 1px solid transparent;
        }
        
        .word-item.found {
            text-decoration: line-through;
            /* اللون والحدّ تُضبط inline حسب لون الكلمة */
        }
        
        .hint-box {
            background: #fff8e1;
            border: 1px dashed #ffd54f;
            padding: 18px 20px;
            border-radius: 12px;
            margin-top: 20px;
            color: #ff8f00;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result {
            margin-top: 20px;
            font-weight: 800;
            font-size: 20px;
            display: none;
            padding: 14px 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .result.ok {
            display: block;
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .result.bad {
            display: block;
            background: #fef2f2;
            color: #7f1d1d;
            border: 1px solid #fecaca;
        }
        
        .footer {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }
        
        .progress {
            --p: 0%;
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }
        
        .progress::after {
            content: "";
            position: absolute;
            inset: 0;
            width: var(--p);
            background: linear-gradient(90deg, #ff7043, #ff9800);
        }
        
        .ribbon {
            position: fixed;
            inset-inline-end: 12px;
            inset-block-start: 12px;
            background: #fff;
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
            font-size: 13px;
            color: #111;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        dialog {
            border: 0;
            border-radius: 16px;
            padding: 0;
            box-shadow: var(--shadow);
            width: min(600px, 95vw);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-head {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #fff;
            font-family: inherit;
        }
        
        label {
            font-size: 14px;
            color: #374151;
        }
        
        .grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }
        
        .grid>div {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .tiny {
            font-size: 13px;
            color: var(--muted);
        }
        
        .level-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .level-card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            border: 2px solid #eee;
            cursor: pointer;
            transition: transform .2s, border-color .2s;
        }
        
        .level-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }
        
        .level-card.active {
            border-color: var(--accent);
            background: #fff8f5;
        }
        
        .level-title {
            font-weight: 800;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .level-desc {
            font-size: 13px;
            color: var(--muted);
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            gap: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        @media (max-width:600px) {
            .grid-cell {
                font-size: calc(var(--cell) * .45);
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="row">
            <div>
                <div class="title">🎮 لعبة <span style="color:var(--accent)">صياد الكلمات</span></div>
                <div class="sub">ابحث عن الكلمات المخفية في الشبكة</div>
            </div>
            <div class="stats">
                <div class="chip">المستوى: <span id="levelNow">1</span></div>
                <div class="chip">النقاط: <span id="scoreNow">0</span> ⭐</div>
                <button class="btn secondary" id="btnLevels">قائمة المستويات</button>
                <button class="btn secondary" id="btnTeacher">وضع المعلّم</button>
            </div>
        </header>

        <div class="card board">
            <div class="hint-box">
                <div>
                    <span>💡 التعليمات:</span>
                    <strong id="instructionText">ابحث عن الكلمات في الاتجاهات الأفقية والعمودية فقط</strong>
                </div>
                <div>الكلمات المطلوبة: <span id="wordsFound">0</span>/<span id="totalWords">0</span></div>
            </div>

            <div class="grid-container" id="gameGrid"></div>

            <div class="word-list" id="wordList"></div>

            <div class="result" id="result"></div>

            <div class="footer">
                <button class="btn" id="btnHint">استخدم تلميح 🪄</button>
                <div class="progress" id="progress"></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn secondary" id="btnResetLevel">إعادة المستوى ↺</button>
                    <button class="btn bad" id="btnReset">بدء من جديد ↺</button>
                    <button class="btn good" id="btnNext" disabled>المستوى التالي ▶</button>
                </div>
            </div>
        </div>
    </div>

    <div class="ribbon">🧠 تقدّمك محفوظ تلقائيًا</div>

    <!-- لوحة المستويات -->
    <dialog id="levelsDlg">
        <div class="modal-head">
            <strong>اختر المستوى المناسب</strong>
            <button class="btn secondary" onclick="levelsDlg.close()">إغلاق</button>
        </div>
        <div class="modal-body">
            <div class="level-selector" id="levelSelector">
                <div class="level-card" data-level="1">
                    <div class="level-title">المستوى الأول</div>
                    <div class="level-desc">كلمات بسيطة من 3-4 أحرف</div>
                </div>
                <div class="level-card" data-level="2">
                    <div class="level-title">المستوى الثاني</div>
                    <div class="level-desc">كلمات من 4-5 أحرف أكثر تنوعًا</div>
                </div>
                <div class="level-card" data-level="3">
                    <div class="level-title">المستوى الثالث</div>
                    <div class="level-desc">كلمات تعبر عن الأنشطة اليومية</div>
                </div>
                <div class="level-card" data-level="4">
                    <div class="level-title">المستوى الرابع</div>
                    <div class="level-desc">كلمات من دروس اللغة العربية</div>
                </div>
                <div class="level-card" data-level="5">
                    <div class="level-title">المستوى الخامس</div>
                    <div class="level-desc">تحدي الكلمات المتقاطعة</div>
                </div>
            </div>
            <div class="action-bar">
                <div class="action-buttons">
                    <button class="btn secondary" id="btnClearLevelProgress">إعادة تعيين المستوى الحالي</button>
                    <button class="btn secondary" id="btnClearAllProgress">إعادة تعيين كل التقدم</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- لوحة المعلّم -->
    <dialog id="teacherDlg">
        <div class="modal-head">
            <strong>وضع المعلّم (إضافة كلمات جديدة)</strong>
            <button class="btn secondary" onclick="teacherDlg.close()">إغلاق</button>
        </div>
        <div class="modal-body">
            <div class="tiny">أضف كلمات جديدة للعبة. يمكنك تحديد المستوى المناسب لكل مجموعة كلمات.</div>
            <div class="grid">
                <div>
                    <label>الكلمات (افصل بينها بفاصلة):</label>
                    <textarea id="tWords" rows="4" placeholder="مثال: قلم، كتاب، مدرسة"></textarea>
                </div>
                <div>
                    <label>المستوى:</label>
                    <select id="tLevel">
            <option value="1">1 (كلمات بسيطة)</option>
            <option value="2">2 (كلمات متنوعة)</option>
            <option value="3">3 (الأنشطة اليومية)</option>
            <option value="4">4 (دروس اللغة العربية)</option>
            <option value="5">5 (كلمات متقاطعة)</option>
          </select>
                </div>
            </div>
            <div style="margin-top:10px;">
                <label>ملاحظات للطلاب (اختياري):</label>
                <input id="tNotes" placeholder="مثال: كلمات من درس الحيوانات">
            </div>
            <div class="row" style="margin-top:12px;">
                <button class="btn" id="btnAddWords">إضافة الكلمات ➕</button>
                <button class="btn bad" id="btnClearAll">حذف الكلمات المضافة 🗑️</button>
            </div>
            <div class="tiny" style="margin-top:8px;">نصيحة: أضف كلمات متعلقة بموضوع واحد في كل مرة لتسهيل التعلم.</div>
        </div>
    </dialog>

    <script>
        (() => {
            // ========== بيانات البداية ==========
            const builtInBank = {
                1: [{
                    words: ["قلم", "كتاب", "باب", "علم", "ولد", "بنت"],
                    notes: "كلمات من البيئة المدرسية"
                }, {
                    words: ["أسد", "نمر", "فيل", "قرد", "دب", "جمل"],
                    notes: "أسماء حيوانات"
                }, {
                    words: ["ماء", "تمر", "عنب", "موز", "تين", "خبز"],
                    notes: "أسماء طعام وشراب"
                }],
                2: [{
                    words: ["مدرسة", "معلم", "طالب", "دفتر", "كرسي", "فصل"],
                    notes: "كلمات من المدرسة"
                }, {
                    words: ["بيت", "غرفة", "مطبخ", "حمام", "سرير", "باب"],
                    notes: "أجزاء المنزل"
                }, {
                    words: ["سيارة", "دراجة", "طائرة", "قطار", "باص", "سفينة"],
                    notes: "وسائل النقل"
                }],
                3: [{
                    words: ["يقرأ", "يكتب", "يلعب", "يأكل", "ينام", "يجري"],
                    notes: "أفعال يومية"
                }, {
                    words: ["صباح", "مساء", "ظهر", "ليل", "نهار", "غروب"],
                    notes: "أوقات اليوم"
                }, {
                    words: ["أحمر", "أزرق", "أصفر", "أخضر", "أسود", "أبيض"],
                    notes: "الألوان"
                }],
                4: [{
                    words: ["حديقة", "مزرعة", "شجرة", "زهرة", "عصفور", "فراشة"],
                    notes: "كلمات من الطبيعة"
                }, {
                    words: ["المعلم", "التلميذ", "المدرسة", "الكتاب", "القلم", "السبورة"],
                    notes: "كلمات بها ال التعريف"
                }, {
                    words: ["رسالة", "قصة", "حكاية", "كلمة", "جملة", "حرف"],
                    notes: "كلمات عن اللغة"
                }],
                5: [{
                    words: ["مسجد", "مدرسة", "مستشفى", "متحف", "مكتبة", "متنزه"],
                    notes: "أماكن عامة"
                }, {
                    words: ["صديق", "أخي", "أمي", "أبي", "جدي", "عمي"],
                    notes: "الأسرة والأقارب"
                }, {
                    words: ["نظيف", "جميل", "كبير", "صغير", "طويل", "قصير"],
                    notes: "صفات"
                }]
            };

            // تحميل كلمات المعلّم من التخزين
            const teacherKey = "wf_teacher_words_v1";
            const loadTeacherWords = () => {
                try {
                    return JSON.parse(localStorage.getItem(teacherKey) || "{}");
                } catch {
                    return {};
                }
            };
            const saveTeacherWords = (data) => localStorage.setItem(teacherKey, JSON.stringify(data || {}));

            // دمج البنوك
            function getFullBank() {
                const t = loadTeacherWords();
                const merged = {
                    1: [...builtInBank[1]],
                    2: [...builtInBank[2]],
                    3: [...builtInBank[3]],
                    4: [...builtInBank[4]],
                    5: [...builtInBank[5]]
                };
                for (const lvl of[1, 2, 3, 4, 5]) {
                    if (t[lvl]) merged[lvl].push(...t[lvl]);
                }
                return merged;
            }

            // حالة اللعبة
            const stateKey = "wf_state_v1";

            function loadState() {
                try {
                    return JSON.parse(localStorage.getItem(stateKey)) || {
                        level: 1,
                        score: 0,
                        done: {},
                        currentLevel: 0,
                        currentPuzzle: 0
                    };
                } catch {
                    return {
                        level: 1,
                        score: 0,
                        done: {},
                        currentLevel: 0,
                        currentPuzzle: 0
                    };
                }
            }
            const state = loadState();
            const saveState = () => localStorage.setItem(stateKey, JSON.stringify(state));

            // عناصر DOM
            const el = {
                levelNow: document.getElementById("levelNow"),
                scoreNow: document.getElementById("scoreNow"),
                instructionText: document.getElementById("instructionText"),
                wordsFound: document.getElementById("wordsFound"),
                totalWords: document.getElementById("totalWords"),
                gameGrid: document.getElementById("gameGrid"),
                wordList: document.getElementById("wordList"),
                result: document.getElementById("result"),
                btnHint: document.getElementById("btnHint"),
                btnReset: document.getElementById("btnReset"),
                btnResetLevel: document.getElementById("btnResetLevel"),
                btnNext: document.getElementById("btnNext"),
                progress: document.getElementById("progress"),
                btnTeacher: document.getElementById("btnTeacher"),
                btnLevels: document.getElementById("btnLevels"),
                teacherDlg: document.getElementById("teacherDlg"),
                levelsDlg: document.getElementById("levelsDlg"),
                levelSelector: document.getElementById("levelSelector"),
                btnClearLevelProgress: document.getElementById("btnClearLevelProgress"),
                btnClearAllProgress: document.getElementById("btnClearAllProgress"),
                tWords: document.getElementById("tWords"),
                tLevel: document.getElementById("tLevel"),
                tNotes: document.getElementById("tNotes"),
                btnAddWords: document.getElementById("btnAddWords"),
                btnClearAll: document.getElementById("btnClearAll")
            };

            // مؤثر صوتي بسيط
            const ctx = new(window.AudioContext || window.webkitAudioContext)();
            // تأكيد تشغيل الصوت (يفكّ القفل مرة واحدة)
            function ensureAudio() {
                if (ctx && ctx.state !== 'running') {
                    ctx.resume().catch(() => {});
                }
            }
            // أول تفاعل من المستخدم نفك القفل
            ['pointerdown', 'touchstart', 'keydown', 'click'].forEach(evt => {
                window.addEventListener(evt, () => ensureAudio(), {
                    once: true,
                    passive: true
                });
            });
            // لو رجعت الصفحة من الخلفية وكان السياق معلّق
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') ensureAudio();
            });

            function beep(freq = 880, ms = 120, type = "sine", vol = .03) {
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = type;
                o.frequency.value = freq;
                g.gain.value = vol;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => o.stop(), ms);
            }

            const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];

            // متغيرات اللعبة
            let gridSize = 8;
            let grid = [];
            let words = [];
            let foundWords = [];
            let selectedCells = [];
            let currentDirection = null;

            // عدّادات لتوازن الاتجاهات (نص بالنص)
            let placedHoriz = 0;
            let placedVert = 0;

            // ألوان لكل كلمة
            const COLORS = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];
            const wordColors = {}; // word -> color

            // Fallback بسيط لـ CSS.escape (لدعم متصفحات قديمة)
            if (typeof window.CSS === 'undefined') window.CSS = {};
            if (typeof window.CSS.escape !== 'function') {
                window.CSS.escape = (s) => s.replace(/[^a-zA-Z0-9_\u0600-\u06FF-]/g, '\\$&');
            }

            // إنشاء شبكة جديدة
            function createGrid(size) {
                gridSize = size;
                grid = [];
                for (let i = 0; i < size; i++) {
                    grid[i] = [];
                    for (let j = 0; j < size; j++) {
                        grid[i][j] = '';
                    }
                }
            }

            // حجم الشبكة حسب المستوى (لتقليل عدد الحروف العشوائية)
            function gridSizeForLevel(level) {
                switch (level) {
                    case 1:
                        return 4; // كلمات قصيرة
                    case 2:
                        return 5;
                    case 3:
                        return 6;
                    case 4:
                        return 7;
                    case 5:
                    default:
                        return 8; // مستوى أعلى
                }
            }

            // تحديث العرض المرئي للشبكة
            function renderGrid() {
                el.gameGrid.style.setProperty('--cols', gridSize);
                el.gameGrid.innerHTML = '';
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        cell.textContent = grid[i][j] || '';
                        cell.addEventListener('mousedown', (e) => startSelection(i, j, e));
                        cell.addEventListener('mouseover', (e) => continueSelection(i, j, e));
                        cell.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            startSelection(i, j, e);
                        });
                        cell.addEventListener('touchmove', (e) => {
                            e.preventDefault();
                            const t = e.touches[0];
                            const elAt = document.elementFromPoint(t.clientX, t.clientY);
                            if (elAt && elAt.classList.contains('grid-cell')) {
                                const r = parseInt(elAt.dataset.row);
                                const c = parseInt(elAt.dataset.col);
                                continueSelection(r, c, e);
                            }
                        });
                        el.gameGrid.appendChild(cell);
                    }
                }
                document.addEventListener('mouseup', endSelection);
                document.addEventListener('touchend', endSelection);
            }

            // قائمة الكلمات
            function renderWordList() {
                el.wordList.innerHTML = '';
                words.forEach(word => {
                    const item = document.createElement('div');
                    item.className = 'word-item' + (foundWords.includes(word) ? ' found' : '');
                    item.textContent = word;
                    item.dataset.word = word;

                    // لو الكلمة لها لون، طبّقه
                    if (foundWords.includes(word) && wordColors[word]) {
                        item.style.color = wordColors[word];
                        item.style.border = `1px solid ${wordColors[word]}`;
                        item.style.background = '#fff';
                    }

                    el.wordList.appendChild(item);
                });
                el.wordsFound.textContent = foundWords.length;
                el.totalWords.textContent = words.length;
            }

            // محاولة وضع جميع الكلمات
            function validateWordPlacement() {
                let attemptCount = 0,
                    maxAttempts = 5;
                while (attemptCount < maxAttempts) {
                    // تصفير العدّادات كل محاولة
                    placedHoriz = 0;
                    placedVert = 0;

                    createGrid(gridSize);
                    let allWordsPlaced = true;
                    for (const w of words) {
                        if (!placeWord(w)) {
                            allWordsPlaced = false;
                            break;
                        }
                    }
                    if (allWordsPlaced) return true;
                    attemptCount++;
                }
                console.warn("لم نتمكن من وضع جميع الكلمات بعد عدة محاولات");
                return false;
            }

            // دالة وضع كلمة مع توازن الاتجاهات + الأربعة اتجاهات
            function placeWord(word) {
                const horizontal = [
                    [0, 1],
                    [0, -1]
                ]; // يمين/يسار
                const vertical = [
                    [1, 0],
                    [-1, 0]
                ]; // أسفل/أعلى

                // نفضّل المجموعة الأقل عدداً حتى الآن (نص بالنص فعلي)
                const preferHorizontal = placedHoriz <= placedVert;
                const groups = preferHorizontal ? [horizontal, vertical] : [vertical, horizontal];

                for (const group of groups) {
                    const dirs = group.slice().sort(() => Math.random() - 0.5);
                    for (const [dy, dx] of dirs) {
                        for (let attempt = 0; attempt < 60; attempt++) {
                            const row = Math.floor(Math.random() * gridSize);
                            const col = Math.floor(Math.random() * gridSize);
                            if (canPlaceWord(word, row, col, dy, dx)) {
                                for (let i = 0; i < word.length; i++) {
                                    const r = row + i * dy,
                                        c = col + i * dx;
                                    grid[r][c] = word[i];
                                }
                                if (dy === 0) placedHoriz++;
                                else placedVert++;
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            function canPlaceWord(word, row, col, dy, dx) {
                for (let i = 0; i < word.length; i++) {
                    const r = row + i * dy,
                        c = col + i * dx;
                    if (r < 0 || r >= gridSize || c < 0 || c >= gridSize) return false;
                    if (grid[r][c] && grid[r][c] !== word[i]) return false;
                }
                return true;
            }

            // ملء باقي الشبكة
            function fillRandomLetters() {
                const arabicLetters = "أبتثجحخدذرزسشصضطظعغفقكلمنهوي";
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        if (!grid[i][j]) grid[i][j] = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
                    }
                }
            }

            // اختيار الحروف
            function startSelection(row, col) {
                clearSelection();
                selectedCells.push({
                    row,
                    col
                });
                updateSelectedCells();
                currentDirection = null;
            }

            function continueSelection(row, col) {
                if (selectedCells.length === 0) return;
                if (selectedCells.some(c => c.row === row && c.col === col)) return;

                const first = selectedCells[0],
                    last = selectedCells[selectedCells.length - 1];

                if (selectedCells.length === 1) {
                    if (row === first.row) {
                        currentDirection = {
                            dy: 0,
                            dx: Math.sign(col - first.col)
                        };
                    } else if (col === first.col) {
                        currentDirection = {
                            dy: Math.sign(row - first.row),
                            dx: 0
                        };
                    } else return;
                } else {
                    const er = last.row + currentDirection.dy,
                        ec = last.col + currentDirection.dx;
                    if (row !== er || col !== ec) return;
                }

                selectedCells.push({
                    row,
                    col
                });
                updateSelectedCells();
            }

            function endSelection() {
                if (selectedCells.length === 0) return;
                const selectedWord = selectedCells.map(c => grid[c.row][c.col]).join('');
                if (words.includes(selectedWord) && !foundWords.includes(selectedWord)) {
                    foundWords.push(selectedWord);

                    // لون ثابت لهذه الكلمة
                    const paletteIndex = Object.keys(wordColors).length % COLORS.length;
                    const color = wordColors[selectedWord] || (wordColors[selectedWord] = COLORS[paletteIndex]);

                    // لوّن الخلايا الصحيحة
                    markCellsAsCorrect(color);

                    // حدّث القائمة ولوّن العنصر
                    renderWordList();
                    const item = el.wordList.querySelector(`[data-word="${CSS.escape(selectedWord)}"]`);
                    if (item) {
                        item.classList.add('found');
                        item.style.color = color;
                        item.style.border = `1px solid ${color}`;
                        item.style.background = '#fff';
                    }

                    beep(1200, 120, "square", .03);
                    state.score += 10;
                    el.scoreNow.textContent = state.score;
                    saveState();
                    if (foundWords.length === words.length) puzzleCompleted();
                } else {
                    beep(200, 150, "sawtooth", .03);
                    clearSelection();
                }
                selectedCells = [];
                currentDirection = null;
            }

            function updateSelectedCells() {
                document.querySelectorAll('.grid-cell.selected').forEach(cell => {
                    if (!cell.classList.contains('correct')) cell.classList.remove('selected');
                });
                selectedCells.forEach(({
                    row,
                    col
                }) => {
                    const cell = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col}"]`);
                    if (cell && !cell.classList.contains('correct')) cell.classList.add('selected');
                });
            }

            // تلوين الخلايا الصحيحة بلون الكلمة
            function markCellsAsCorrect(color = '#4caf50') {
                selectedCells.forEach(({
                    row,
                    col
                }) => {
                    const cell = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col}"]`);
                    if (cell) {
                        cell.classList.remove('selected');
                        cell.classList.add('correct');
                        cell.style.borderColor = color;
                        cell.style.color = color;
                        cell.style.backgroundColor = '#fff';
                    }
                });
            }

            function clearSelection() {
                document.querySelectorAll('.grid-cell.selected').forEach(cell => {
                    if (!cell.classList.contains('correct')) cell.classList.remove('selected');
                });
                selectedCells = [];
            }

            // تلميح يدعم الاتجاهات الأربعة (وبلون الكلمة إن وُجد)
            function useHint() {
                const remaining = words.filter(w => !foundWords.includes(w));
                if (remaining.length === 0) return;
                const w = rand(remaining);

                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        const directions = [
                            [0, 1], // أفقي يمين
                            [0, -1], // أفقي يسار
                            [1, 0], // عمودي أسفل
                            [-1, 0], // عمودي أعلى
                        ];
                        for (const [dy, dx] of directions) {
                            if (checkWordAtPosition(w, i, j, dy, dx)) {
                                flashWord(w, i, j, dy, dx);
                                return;
                            }
                        }
                    }
                }
            }

            function checkWordAtPosition(word, row, col, dy, dx) {
                if (row + dy * (word.length - 1) >= gridSize || row + dy * (word.length - 1) < 0) return false;
                if (col + dx * (word.length - 1) >= gridSize || col + dx * (word.length - 1) < 0) return false;
                for (let i = 0; i < word.length; i++) {
                    const r = row + i * dy,
                        c = col + i * dx;
                    if (grid[r][c] !== word[i]) return false;
                }
                return true;
            }

            function flashWord(word, row, col, dy, dx) {
                const color = wordColors[word] || '#ffd54f';
                const cells = [];
                for (let i = 0; i < word.length; i++) {
                    const r = row + i * dy,
                        c = col + i * dx;
                    const cell = document.querySelector(`.grid-cell[data-row="${r}"][data-col="${c}"]`);
                    if (cell) {
                        cells.push(cell);
                        cell.style.transition = "outline-color 0.3s, outline-width 0.3s";
                        cell.style.outline = `3px solid ${color}`;
                    }
                }
                setTimeout(() => cells.forEach(c => {
                    c.style.outline = "";
                }), 1000);
                state.score = Math.max(0, state.score - 5);
                el.scoreNow.textContent = state.score;
                saveState();
            }

            function puzzleCompleted() {
                el.result.className = "result ok";
                el.result.textContent = "🎉 أحسنت! لقد وجدت جميع الكلمات";
                el.result.style.display = "block";
                el.btnNext.disabled = false;
                state.score += 10;
                el.scoreNow.textContent = state.score;
                markPuzzleCompleted();
                confetti();
            }

            function getWordSet() {
                const bank = getFullBank()[state.level];
                if (!bank || bank.length === 0) return {
                    words: [],
                    notes: "لا توجد كلمات"
                };
                if (state.currentPuzzle >= bank.length) state.currentPuzzle = 0;
                return bank[state.currentPuzzle];
            }

            // مؤثر بسيط
            function confetti() {
                const n = 25,
                    dur = 1200;
                for (let i = 0; i < n; i++) {
                    const p = document.createElement("div");
                    p.style.position = "fixed";
                    p.style.width = "10px";
                    p.style.height = "10px";
                    p.style.background = `hsl(${Math.random()*360},90%,60%)`;
                    p.style.insetInlineStart = (Math.random() * 80 + 10) + "vw";
                    p.style.insetBlockStart = "0vh";
                    p.style.borderRadius = "2px";
                    p.style.transform = `rotate(${Math.random()*360}deg)`;
                    p.style.zIndex = 9999;
                    document.body.appendChild(p);
                    p.animate([{
                        transform: `translateY(0) rotate(0deg)`
                    }, {
                        transform: `translateY(80vh) rotate(${Math.random()*720-360}deg)`
                    }], {
                        duration: dur + Math.random() * 600,
                        easing: "cubic-bezier(.2,.7,.2,1)"
                    }).onfinish = () => p.remove();
                }
            }

            // إعداد مختار المستويات
            function setupLevelSelector() {
                const cards = el.levelSelector.querySelectorAll('.level-card');
                cards.forEach(card => {
                    const level = parseInt(card.dataset.level);
                    card.addEventListener('click', () => {
                        cards.forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        state.level = level;
                        state.currentPuzzle = 0;
                        saveState();
                        el.levelsDlg.close();
                        createNewPuzzle();
                    });
                    if (level === state.level) card.classList.add('active');
                });
            }

            function markPuzzleCompleted() {
                if (!state.done[state.level]) state.done[state.level] = [];
                const key = `${state.level}-${state.currentPuzzle}`;
                if (!state.done[state.level].includes(key)) state.done[state.level].push(key);
                saveState();
                updateProgress();
            }

            function isPuzzleCompleted() {
                if (!state.done[state.level]) return false;
                const key = `${state.level}-${state.currentPuzzle}`;
                return state.done[state.level].includes(key);
            }

            function nextPuzzle() {
                state.currentPuzzle++;
                const bank = getFullBank()[state.level];
                if (state.currentPuzzle >= bank.length) state.currentPuzzle = 0;
                saveState();
                createNewPuzzle();
            }

            function updateProgress() {
                const bank = getFullBank()[state.level];
                if (!bank || bank.length === 0) return;
                const total = bank.length;
                let completed = 0;
                if (state.done[state.level]) {
                    bank.forEach((_, idx) => {
                        const key = `${state.level}-${idx}`;
                        if (state.done[state.level].includes(key)) completed++;
                    });
                }
                const percent = Math.round(100 * completed / total);
                el.progress.style.setProperty("--p", percent + "%");
            }

            // إنشاء لغز جديد
            function createNewPuzzle() {
                foundWords = [];
                selectedCells = [];
                currentDirection = null;

                // 👇 حجم الشبكة حسب المستوى لتقليل الزحمة
                gridSize = gridSizeForLevel(state.level);

                const wordSet = getWordSet();
                words = wordSet.words;

                // ترتيب الأطول أولاً يساعد ينجح الوضع
                words = [...words].sort((a, b) => b.length - a.length);

                el.instructionText.textContent = wordSet.notes || "ابحث عن الكلمات في الاتجاهات الأفقية والعمودية فقط";
                el.levelNow.textContent = state.level;
                el.scoreNow.textContent = state.score;

                const ok = validateWordPlacement();
                if (!ok) {
                    createGrid(gridSize);
                    // تصفير العدّادات قبل الخطة الاحتياطية
                    placedHoriz = 0;
                    placedVert = 0;
                    words.forEach(w => placeWord(w));
                }

                fillRandomLetters();
                renderGrid();
                renderWordList();

                el.result.style.display = "none";
                el.btnNext.disabled = true;
                updateProgress();
            }

            // بدء اللعبة
            setupLevelSelector();
            createNewPuzzle();

            // أزرار
            el.btnHint.addEventListener("click", useHint);
            el.btnReset.addEventListener("click", () => {
                if (confirm("هل تريد إعادة بدء اللعبة من البداية؟")) {
                    state.level = 1;
                    state.score = 0;
                    state.currentPuzzle = 0;
                    saveState();
                    createNewPuzzle();
                }
            });
            el.btnResetLevel.addEventListener("click", () => {
                if (confirm("هل تريد إعادة تعيين المستوى الحالي؟")) createNewPuzzle();
            });
            el.btnNext.addEventListener("click", nextPuzzle);
            el.btnTeacher.addEventListener("click", () => el.teacherDlg.showModal());
            el.btnLevels.addEventListener("click", () => {
                setupLevelSelector();
                el.levelsDlg.showModal();
            });

            el.btnClearLevelProgress.addEventListener("click", () => {
                if (confirm(`هل تريد إعادة تعيين التقدم للمستوى ${state.level}؟`)) {
                    if (state.done[state.level]) {
                        state.done[state.level] = [];
                        saveState();
                        alert(`تم إعادة تعيين المستوى ${state.level}`);
                        el.levelsDlg.close();
                        createNewPuzzle();
                    }
                }
            });
            el.btnClearAllProgress.addEventListener("click", () => {
                if (confirm("هل تريد إعادة تعيين كل التقدم في جميع المستويات؟")) {
                    state.done = {};
                    state.score = 0;
                    saveState();
                    alert("تم إعادة تعيين كل التقدم");
                    el.levelsDlg.close();
                    createNewPuzzle();
                }
            });

            el.btnAddWords.addEventListener("click", () => {
                const wordsInput = (el.tWords.value || "").trim();
                if (!wordsInput) {
                    alert("أضف الكلمات أولاً (مفصولة بفواصل)");
                    return;
                }
                const list = wordsInput.split(/[,،]/).map(w => w.trim()).filter(w => w.length > 0);
                if (list.length === 0) {
                    alert("لم يتم العثور على كلمات صالحة");
                    return;
                }
                const lvl = parseInt(el.tLevel.value || "1");
                const notes = (el.tNotes.value || "").trim() || "كلمات مضافة من المعلم";
                const data = loadTeacherWords();
                if (!data[lvl]) data[lvl] = [];
                data[lvl].push({
                    words: list,
                    notes
                });
                saveTeacherWords(data);
                el.tWords.value = "";
                el.tNotes.value = "";
                alert("تمت الإضافة ✅ ستظهر في المستوى عند التشغيل التالي.");
            });
            el.btnClearAll.addEventListener("click", () => {
                if (confirm("حذف كل كلمات المعلّم؟")) {
                    saveTeacherWords({});
                    alert("تم الحذف.");
                }
            });

        })();
    </script>
</body>

</html>